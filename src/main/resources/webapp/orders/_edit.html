<form id="orderForm">
  <div>
    <label>Order title:</label>
    <input type="text" name="order[title]" required placeholder="Title" />
  </div>

  <p>
    <button>Save order</button>
  </p>

  <div id="orderContents">
    <h4>Order contents</h4>
    <div id="orderLines"></div>
    <button id="addOrderLine">Add line</button>
  </div>
</form>

<script type="text/x-handlebars-template" id="orderLineTemplate">
  <div class="orderLine">
    <span>Product</span>
    <select name="order[orderlines][][product]" class="productSelect" required>
      <option value>(Not selected)</option>      
      {{#each products}}
        <option value={{id}}>{{title}}</option>
      {{/each}}
    </select>
    <input type="number" name="order[orderlines][][amount]" required min=1 step=1 placeholder="amount" />
  </div>
</script>

<script src="/seedapp/vendor/jquery.serialize-object.min.js"></script>

<script type="text/javascript">
  $(function() {
    var products;
    var orderTemplate = Handlebars.compile($("#orderLineTemplate").html());

    productRepository.list().then(function(data) {
      products = data.products;
      $("#orderLines").append(orderTemplate({products: products}));
      $("#orderLines").append(orderTemplate({products: products}));
    });

    $("#addOrderLine").click(function(e) {
      e.preventDefault();
      if (products) {
        $("#orderLines").append(orderTemplate({products: products}));
        $("#orderLines .productSelect").last().focus()
      }
    });

    $("#orderForm").submit(function(e) {
      e.preventDefault();
      var form = $("form#orderForm").serializeObject();
      orderRepository.save(form.order).then(function() {
        window.location.hash = "orders";
      });
    });
  });
</script>